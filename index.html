<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/kanban.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Easy Kanban</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Store original URL immediately when page starts loading (before any redirects)
      (function() {
        const fullUrl = window.location.href;
        if (fullUrl.includes('/project/') && fullUrl.includes('#')) {
          console.log('ðŸŽ¯ Pre-redirect - storing original URL:', fullUrl);
          sessionStorage.setItem('originalIntendedUrl', fullUrl);
        }
      })();
    </script>
    <script>
      // Capture intended destination immediately when page loads, before any other scripts
      (function() {
        const currentHash = window.location.hash;
        const currentPathname = window.location.pathname;
        const referrer = document.referrer;
        
        
        // Check if we were redirected from a /project/ URL (which would be the intended destination)
        if (referrer && referrer.includes('/project/') && currentHash === '#login' && currentPathname === '/') {
          try {
            const referrerUrl = new URL(referrer);
            let intendedDestination = referrerUrl.pathname;
            
            // Hash is lost during HTTP redirect, so check if we have it stored from before the redirect
            const storedFullUrl = sessionStorage.getItem('originalIntendedUrl');
            if (storedFullUrl) {
              try {
                const storedUrl = new URL(storedFullUrl);
                intendedDestination = storedUrl.pathname + storedUrl.hash;
                sessionStorage.removeItem('originalIntendedUrl'); // Clean up
              } catch (e) {
                // Fallback to referrer path only
              }
            }
            localStorage.setItem('capturedIntendedDestination', intendedDestination);
          } catch (e) {
            // Failed to parse referrer URL
          }
        } else if (currentHash === '#login' && currentPathname === '/' && !referrer.includes('/project/')) {
          // Clear stale data only when visiting login page directly (not from a /project/ redirect)
          localStorage.removeItem('capturedIntendedDestination');
          sessionStorage.removeItem('originalIntendedUrl');
        }
        
        // Also capture from current URL if it's a protected page
        if (currentHash && currentHash !== '' && currentHash !== '#') {
          const route = currentHash.replace('#', '');
          const publicPages = ['login', 'forgot-password', 'reset-password', 'reset-success', 'activate-account'];
          const isPublicPage = publicPages.some(page => route.startsWith(page));
          
          if (!isPublicPage) {
            const fullPath = currentPathname + currentHash;
            const intendedUrl = fullPath === '/' ? currentHash : fullPath;
            localStorage.setItem('capturedIntendedDestination', intendedUrl);
          }
        }
        
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
